# ------------------------------------------------------------------------------------
# PRODUCTION DOCKER COMPOSE FOR n8n (QUEUE MODE)
# TARGET HARDWARE: 2 vCPU / 8 GB RAM
# ------------------------------------------------------------------------------------
#
# PHILOSOPHY:
# 1. QUEUE MODE: With 2 vCPUs and 8 GB RAM, we can afford the overhead of queue mode.
#    This architecture provides superior performance and stability by separating tasks:
#      - n8n-main: Handles only the UI, API, and webhooks, ensuring a responsive interface.
#      - n8n-worker: A dedicated container that does the heavy lifting of executing workflows.
#      - Redis: A lightweight message broker that manages the queue between main and worker.
# 2. DEDICATED RESOURCES: Resources are strategically allocated. The database and the
#    worker get the largest shares of CPU and RAM, as they are the most critical
#    components for performance.
# 3. HIGH CONCURRENCY: The single worker is configured with high concurrency to process
#    many workflows in parallel, maximizing the efficiency of database connections.
#

services:
  # ---------------------------------------------------------------
  # PostgreSQL Database Service
  # ---------------------------------------------------------------
  postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # CRITICAL OPTIMIZATION: A higher connection limit is essential for queue mode
    # to support the connection pool used by the high-concurrency worker.
    command: postgres -c 'max_connections=200'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    # --- RESOURCE ALLOCATION ---
    # The database is given a high priority for resources.
    deploy:
      resources:
        limits:
          cpus: "1.0" # Guarantees up to 1 full CPU core for database operations.
          memory: 3.5G  # Allocates 3.5 GB of RAM for caching and performance.

  # ---------------------------------------------------------------
  # Redis Message Broker Service
  # ---------------------------------------------------------------
  redis:
    image: redis:8-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    # --- RESOURCE ALLOCATION ---
    # Redis is extremely lightweight and requires minimal resources.
    deploy:
      resources:
        limits:
          cpus: "0.2"  # 20% of a CPU core is more than enough.
          memory: 512M # 512 MB is ample memory for the job queue.

  # ---------------------------------------------------------------
  # N8N Main Instance (UI, Webhooks, API)
  # ---------------------------------------------------------------
  n8n-main:
    # IMPORTANT: Pinning to a specific version is crucial for production stability.
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    # The main instance handles the UI and queues jobs. It depends on both Postgres and Redis.
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      # --- Execution Mode ---
      # 'queue' mode offloads all executions to dedicated workers.
      - EXECUTIONS_MODE=queue

      # --- Database & Redis Connection ---
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QUEUE_BULL_REDIS_HOST=redis             # Tells n8n where to find the Redis queue.

      # --- Security, Host, and other settings (same as main mode) ---
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - NODE_ENV=production
      - N8N_HOST=${N8N_HOST}
      - WEBHOOK_URL=https://${N8N_HOST}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      # ... (add other variables like PROXY, PRUNE, etc. as needed)
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # The main instance is less resource-intensive in queue mode.
    deploy:
      resources:
        limits:
          cpus: "0.5"  # Half a core is sufficient for managing the UI and API.
          memory: 1.5G # 1.5 GB provides a smooth and responsive user experience.

  # ---------------------------------------------------------------
  # N8N Worker Instance (Executes Workflows)
  # ---------------------------------------------------------------
  n8n-worker:
    # The worker image version MUST exactly match the main instance version.
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    # This command starts the container in 'worker' mode.
    # --concurrency=10 tells this single worker to handle up to 10 jobs in parallel.
    # This is the key to high throughput, as it reuses database connections efficiently.
    command: worker --concurrency=10
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    environment:
      # --- Execution Mode ---
      - EXECUTIONS_MODE=queue
      # --- Database & Redis Connection (same as main) ---
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QUEUE_BULL_REDIS_HOST=redis
      # --- Security ---
      # The worker MUST use the exact same encryption key to decrypt credentials.
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
    # The worker shares the same volume to access workflow and credential data.
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # The worker does the heavy lifting and gets a larger share of resources.
    deploy:
      resources:
        limits:
          cpus: "1.0"  # Dedicate one full CPU core to workflow executions.
          memory: 2.5G   # Allocate 2.5 GB for workflows. Adjust if you have memory-heavy nodes.

# Named volumes are essential for persisting all your data.
volumes:
  n8n_data:
  postgres_data:
  redis_data: