# ------------------------------------------------------------------------------------
# PRODUCTION DOCKER COMPOSE FOR n8n (QUEUE MODE - 2 WORKERS)
# TARGET HARDWARE: 4 vCPU / 16 GB RAM
# ------------------------------------------------------------------------------------
#
# PHILOSOPHY:
# 1. QUEUE MODE WITH 2 WORKERS: With 4 vCPUs and 16 GB RAM, we can run 2 dedicated
#    workers for maximum throughput and reliability. This architecture provides:
#      - n8n-main: Handles only the UI, API, and webhooks
#      - n8n-worker-1 & n8n-worker-2: Two dedicated containers for executing workflows
#      - Redis: Lightweight message broker managing the queue
# 2. DEDICATED RESOURCES: Resources are strategically allocated across all services
#    to maximize performance and stability.
# 3. OPTIMIZED CONCURRENCY: Each worker runs with concurrency 12 (total 24) to process
#    many workflows in parallel while maintaining stability on 4 vCPU systems.
# 4. TASK RUNNERS (EXTERNAL): External task runners in a sidecar container provide
#    secure Code node execution with proper isolation.
#

services:
  # --------------------------------
  # PostgreSQL Database Service
  # --------------------------------
  postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # CRITICAL OPTIMIZATION: Increases the default database connection limit.
    # With 2 workers at high concurrency, we need more connections. 300 provides
    # a safe ceiling and prevents "too many connections" errors under load.
    command: postgres -c 'max_connections=300'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    # --- RESOURCE ALLOCATION ---
    # The database gets a significant share of resources for optimal performance.
    deploy:
      resources:
        limits:
          cpus: "1.5"   # Guarantees 1.5 CPU cores for database operations.
          memory: 6.5G  # Allocates 6.5 GB of RAM for caching and performance.

  # --------------------------------
  # Redis Message Broker Service
  # --------------------------------
  redis:
    image: redis:8-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    # --- RESOURCE ALLOCATION ---
    # Redis is extremely lightweight and requires minimal resources.
    deploy:
      resources:
        limits:
          cpus: "0.2"   # 20% of a CPU core is more than enough.
          memory: 512M  # 512 MB is ample memory for the job queue.

  # --------------------------------
  # Main n8n Instance (UI, Webhooks, API)
  # --------------------------------
  n8n-main:
    # Pinning the image version is a best practice for production stability.
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # --- Execution Mode ---
      - EXECUTIONS_PROCESS=queue                # Enables queue mode for distributed execution.

      # --- Database Connection Configuration ---
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

      # --- Redis Configuration ---
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_DB=0
      - QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
      - N8N_GRACEFUL_SHUTDOWN_TIMEOUT=30

      # --- Security & Encryption ---
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_SECURE_COOKIE=true

      # --- Host & Network Settings ---
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production                     # Enables performance optimizations.
      - WEBHOOK_URL=https://${N8N_HOST}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}

      # --- Proxy Configuration ---
      - N8N_TRUST_PROXY=true
      - N8N_PROXY_HOPS=1

      # --- Performance & Cleanup ---
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168             # Prunes execution data older than 7 days.
      - N8N_PERSONALIZATION_ENABLED=false
      - N8N_TEMPLATES_ENABLED=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true

      # --- Task Runners (External Mode) ---
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=external
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # The main instance handles UI and API, needs moderate resources.
    deploy:
      resources:
        limits:
          cpus: "0.5"   # 0.5 CPU cores for managing the UI and API.
          memory: 2G    # 2 GB provides a smooth user experience.

  # --------------------------------
  # Worker Instance #1
  # --------------------------------
  n8n-worker-1:
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    # CRITICAL OPTIMIZATION: Concurrency (12) provides excellent throughput
    # while maintaining stability on 4 vCPU systems. Total: 2 workers Ã— 12 = 24 parallel executions.
    command: worker --concurrency=12
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - EXECUTIONS_PROCESS=queue
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_DB=0
      - QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
      - N8N_GRACEFUL_SHUTDOWN_TIMEOUT=30
      # IMPORTANT: The encryption key must be identical across all n8n services.
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # Worker 1 gets a significant share for heavy workflow execution.
    deploy:
      resources:
        limits:
          cpus: "0.8"   # 0.8 CPU cores for workflow executions.
          memory: 3.5G  # 3.5 GB for workflows and their data.

  # --------------------------------
  # Worker Instance #2
  # --------------------------------
  n8n-worker-2:
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    # CRITICAL OPTIMIZATION: The second worker runs at the same concurrency.
    command: worker --concurrency=12
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - EXECUTIONS_PROCESS=queue
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_DB=0
      - QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
      - N8N_GRACEFUL_SHUTDOWN_TIMEOUT=30
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # Worker 2 gets equal resources to Worker 1 for balanced load distribution.
    deploy:
      resources:
        limits:
          cpus: "0.8"   # 0.8 CPU cores for workflow executions.
          memory: 3.5G  # 3.5 GB for workflows and their data.

  # --------------------------------
  # Task Runners (External Mode - Sidecar)
  # --------------------------------
  task-runners:
    # The runners image version MUST exactly match the n8n version.
    image: n8nio/runners:1.117.3
    restart: unless-stopped
    depends_on:
      - n8n-main
    environment:
      # --- Task Runner Configuration ---
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n-main:5679
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=15
    # --- RESOURCE ALLOCATION ---
    # Task runners are lightweight and need minimal resources.
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 512M

# Named volumes ensure that your data persists even if containers are removed.
volumes:
  n8n_data:
  postgres_data:
  redis_data: