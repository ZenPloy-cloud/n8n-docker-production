# ------------------------------------------------------------------------------------
# PRODUCTION DOCKER COMPOSE FOR n8n (QUEUE MODE - 3 WORKERS)
# TARGET HARDWARE: 4 vCPU / 16 GB RAM
# ------------------------------------------------------------------------------------
#
# ⚠️ WARNING: 3 workers is at the MAXIMUM recommended limit!
# For most use cases, 2 workers with higher concurrency performs BETTER.
# Only use 3 workers if you have confirmed database bottlenecks with 2 workers.
#
# PHILOSOPHY:
# 1. QUEUE MODE WITH 3 WORKERS: This is the maximum recommended for this hardware.
#    More workers = more database connections = more lock contention = slower performance.
# 2. LOWER CONCURRENCY: With 3 workers, concurrency is reduced to 12 per worker
#    to avoid overwhelming the database (3 × 12 = 36 total parallel executions).
# 3. DEDICATED RESOURCES: Resources are divided across 5 services, which may
#    lead to resource contention under heavy load.
#

services:
  # --------------------------------
  # PostgreSQL Database Service
  # --------------------------------
  postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # CRITICAL OPTIMIZATION: With 3 workers, we need more connections.
    # 300 provides a safe ceiling for 3 workers at concurrency 12.
    command: postgres -c 'max_connections=300'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    # --- RESOURCE ALLOCATION ---
    # Database gets significant resources but less than 2-worker config.
    deploy:
      resources:
        limits:
          cpus: "1.3"   # 1.3 CPU cores for database operations.
          memory: 5.5G  # 5.5 GB of RAM for caching and performance.

  # --------------------------------
  # Redis Message Broker Service
  # --------------------------------
  redis:
    image: redis:8-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    # --- RESOURCE ALLOCATION ---
    # Redis is lightweight and requires minimal resources.
    deploy:
      resources:
        limits:
          cpus: "0.3"   # 30% of a CPU core.
          memory: 1G    # 1 GB for the job queue.

  # --------------------------------
  # Main n8n Instance (UI, Webhooks, API)
  # --------------------------------
  n8n-main:
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - EXECUTIONS_MODE=queue
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_DB=0
      - QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
      - N8N_GRACEFUL_SHUTDOWN_TIMEOUT=30
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_SECURE_COOKIE=true
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://${N8N_HOST}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_TRUST_PROXY=true
      - N8N_PROXY_HOPS=1
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168
      - N8N_PERSONALIZATION_ENABLED=false
      - N8N_TEMPLATES_ENABLED=true
      - N8N_RUNNERS_ENABLED=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # Main instance handles UI and API.
    deploy:
      resources:
        limits:
          cpus: "0.6"   # 0.6 CPU cores for UI and API.
          memory: 1.8G  # 1.8 GB for smooth user experience.

  # --------------------------------
  # Worker Instance #1
  # --------------------------------
  n8n-worker-1:
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    # OPTIMIZATION: Concurrency is slightly lowered to 12 to balance the
    # database load across three workers. (3 workers * 12 = 36 parallel executions)
    command: worker --concurrency=12
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - EXECUTIONS_MODE=queue
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_DB=0
      - QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
      - N8N_GRACEFUL_SHUTDOWN_TIMEOUT=30
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_RUNNERS_ENABLED=true
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # Worker 1 gets resources for workflow execution.
    deploy:
      resources:
        limits:
          cpus: "0.6"   # 0.6 CPU cores for workflows.
          memory: 2.5G  # 2.5 GB for workflow data.

  # --------------------------------
  # Worker Instance #2
  # --------------------------------
  n8n-worker-2:
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    command: worker --concurrency=12
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - EXECUTIONS_MODE=queue
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_DB=0
      - QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
      - N8N_GRACEFUL_SHUTDOWN_TIMEOUT=30
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_RUNNERS_ENABLED=true
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # Worker 2 gets equal resources to Worker 1.
    deploy:
      resources:
        limits:
          cpus: "0.6"   # 0.6 CPU cores for workflows.
          memory: 2.5G  # 2.5 GB for workflow data.

  # --------------------------------
  # Worker Instance #3
  # --------------------------------
  n8n-worker-3:
    image: n8nio/n8n:1.117.3
    restart: unless-stopped
    command: worker --concurrency=12
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - EXECUTIONS_MODE=queue
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_DB=0
      - QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=10000
      - N8N_GRACEFUL_SHUTDOWN_TIMEOUT=30
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_RUNNERS_ENABLED=true
    volumes:
      - n8n_data:/home/node/.n8n
    # --- RESOURCE ALLOCATION ---
    # Worker 3 gets equal resources to Workers 1 & 2.
    deploy:
      resources:
        limits:
          cpus: "0.6"   # 0.6 CPU cores for workflows.
          memory: 2.5G  # 2.5 GB for workflow data.

volumes:
  n8n_data:
  postgres_data:
  redis_data: